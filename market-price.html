<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kerala Farmers â€” Market Prices</title>
<style>
:root {
    --ivory: #FFFFF0;
    --olive: #556B2F;
    --shadow: 0 6px 18px rgba(0,0,0,0.12);
    --bg-color: linear-gradient(160deg, var(--ivory), #E8E7D8 30%, var(--olive) 100%);
    --frame-bg: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,240,0.96));
    --text-color: #333;
    --icon-btn-bg: rgba(255,255,255,0.9);
    --icon-color: var(--olive);
    font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}
body {
    margin:0; padding:0;
    display:flex; justify-content:center; align-items:flex-start;
    min-height:100vh;
    background: var(--bg-color);
}
#phone-frame {
    width: 375px; background: var(--frame-bg);
    border-radius: 40px; box-shadow: var(--shadow);
    overflow:hidden; padding-bottom:20px;
}
header {
    display:flex; align-items:center; padding:15px;
    background: var(--frame-bg); position:sticky; top:0; z-index:10;
}
header h1 { margin:0; font-size:20px; color:var(--text-color); flex:1; text-align:center;}
.icon-button { background: var(--icon-btn-bg); border:none; border-radius:50%; width:36px; height:36px; display:flex; justify-content:center; align-items:center; cursor:pointer; margin:0 3px;}
.icon-button svg { fill: var(--icon-color); width:18px; height:18px;}
.screen-content { padding:15px; color: var(--text-color);}
.info-card { background: var(--icon-btn-bg); padding:15px; border-radius:20px; text-align:center; margin-bottom:15px;}
.info-card h2 { margin:0 0 5px; }
.info-card p { margin:0; font-size:0.9em;}
label { display:block; margin-top:10px; font-size:0.9em;}
input, select, button { width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;}
button { background:var(--olive); color:white; cursor:pointer; border:none;}
button:hover { background:#6c8b46;}
.commodity-list { margin-top:15px; }
.commodity-item { background: var(--icon-btn-bg); padding:10px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.commodity-item h4 { margin:0 0 5px; font-size:1em;}
.commodity-item p { margin:2px 0; font-size:0.85em;}
.input-group { display:flex; gap:5px; }
.input-group button { width:50px; padding:0; font-size:16px; }
.unit-select { margin-top:5px; }
#location-suggestions { border:1px solid #ccc; border-radius:5px; max-height:100px; overflow-y:auto; background:white; position:relative; z-index:5; }
#location-suggestions div:hover { background:#f0f0f0; }
</style>
</head>
<body>
<div id="phone-frame">
    <header>
        <h1>Market Prices</h1>
    </header>
    <div class="screen-content">
        <div class="info-card">
            <h2>ðŸŒ± Kerala Farmers</h2>
            <p>Your companion for a thriving harvest</p>
        </div>

        <!-- Auto Location -->
        <label>Detected Location (Auto):</label>
        <input type="text" id="auto-location" readonly>

        <!-- Manual Location -->
        <label>Manual Location (Optional):</label>
        <input type="text" id="manual-location" placeholder="Enter city/district">
        <div id="location-suggestions"></div>

        <!-- Crop Selection -->
        <label>Select Crop:</label>
        <select id="crop-select">
            <option value="">-- Select Crop --</option>
            <option>Chili Red</option>
            <option>Tomato</option>
            <option>Potato</option>
            <option>Onion</option>
            <option>Brinjal</option>
            <option>Cucumber</option>
            <option>Cabbage</option>
            <option>Cauliflower</option>
            <option>Okra</option>
            <option>Beans</option>
            <option>Spinach</option>
            <option>Banana</option>
            <option>Coconut</option>
            <option>Arecanut</option>
            <option>Papaya</option>
            <option>Mango</option>
            <option>Pineapple</option>
            <option>Turmeric</option>
            <option>Ginger</option>
        </select>

        <label>Or type crop name:</label>
        <div class="input-group">
            <input type="text" id="manual-crop" placeholder="Enter crop name">
            <button onclick="manualSetCrop()">âœ”</button>
        </div>

        <!-- Price Unit -->
        <label>Price Unit:</label>
        <select id="unit-select" class="unit-select">
            <option value="quintal">/Quintal</option>
            <option value="kg">/kg</option>
            <option value="100kg">/100kg</option>
        </select>

        <!-- Market Prices -->
        <div class="commodity-list" id="commodity-prices">
            <p>Loading market data...</p>
        </div>
    </div>
</div>

<script>
const apiKey = '579b464db66ec23bdd0000017bef73f4f1bc4439694b32dbf0f004d8';
let currentState='', currentDistrict='';

// Auto Location Detection
async function getAutoLocation() {
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async pos=>{
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await res.json();
                const district = data.address.county || data.address.city || '';
                const state = data.address.state || '';
                document.getElementById('auto-location').value = `${district}, ${state}`;
                currentState = state; currentDistrict = district;
                fetchMarketPrices();
            } catch(e){
                document.getElementById('auto-location').value = 'Unable to detect';
            }
        }, err=>{
            document.getElementById('auto-location').value = 'Unable to detect';
        });
    } else document.getElementById('auto-location').value = 'Geolocation not supported';
}

// Manual Location Autocomplete
const manualLocationInput = document.getElementById('manual-location');
const suggestionBox = document.getElementById('location-suggestions');
let manualLocationTimeout;

manualLocationInput.addEventListener('input', ()=>{
    const query = manualLocationInput.value.trim();
    suggestionBox.innerHTML = '';
    if(!query) return;
    
    clearTimeout(manualLocationTimeout);
    manualLocationTimeout = setTimeout(async ()=>{
        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`);
            const data = await res.json();
            suggestionBox.innerHTML = '';
            data.forEach(place=>{
                const div = document.createElement('div');
                div.style.padding='5px';
                div.style.cursor='pointer';
                div.textContent = place.display_name;
                div.onclick = ()=>{
                    const district = place.address.county || place.address.city || '';
                    const state = place.address.state || '';
                    document.getElementById('auto-location').value = `${district}, ${state}`;
                    currentState = state;
                    currentDistrict = district;
                    suggestionBox.innerHTML='';
                    manualLocationInput.value = '';
                    fetchMarketPrices();
                };
                suggestionBox.appendChild(div);
            });
        } catch(e){ console.log(e); }
    }, 300);
});

// Manual Crop
function manualSetCrop(){
    const val = document.getElementById('manual-crop').value.trim();
    if(!val) return alert('Enter a crop name');
    fetchMarketPrices();
}

// Fetch Market Prices
async function fetchMarketPrices(){
    const manualCrop = document.getElementById('manual-crop').value.trim();
    const selectedCrop = document.getElementById('crop-select').value;
    const crop = manualCrop || selectedCrop;
    if(!crop) return;

    const container = document.getElementById('commodity-prices');
    container.innerHTML = 'Loading...';

    const unit = document.getElementById('unit-select').value;
    let multiplier = 1;
    if(unit==='kg') multiplier=0.01;
    else if(unit==='100kg') multiplier=1;

    try {
        const res = await fetch(`https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${apiKey}&format=json&filters[state.keyword]=${encodeURIComponent(currentState)}&filters[district]=${encodeURIComponent(currentDistrict)}&filters[commodity]=${encodeURIComponent(crop)}&limit=10`);
        const data = await res.json();
        container.innerHTML = '';
        if(data.records && data.records.length){
            data.records.forEach(r=>{
                const div = document.createElement('div');
                div.className='commodity-item';
                const min = r.min_price ? Math.round(r.min_price*multiplier) : 'N/A';
                const max = r.max_price ? Math.round(r.max_price*multiplier) : 'N/A';
                const modal = r.modal_price ? Math.round(r.modal_price*multiplier) : 'N/A';
                div.innerHTML = `
                    <h4>${r.commodity} - ${r.market}</h4>
                    <p>Date: ${r.arrival_date}</p>
                    <p>Min Price: â‚¹${min} ${unit}</p>
                    <p>Max Price: â‚¹${max} ${unit}</p>
                    <p>Modal Price: â‚¹${modal} ${unit}</p>
                `;
                container.appendChild(div);
            });
        } else container.innerHTML = '<p>No market data found.</p>';
    } catch(e){
        container.innerHTML='<p>Error fetching market data.</p>';
    }
}

// Crop dropdown + manual sync
const cropSelect = document.getElementById('crop-select');
const manualCropInput = document.getElementById('manual-crop');

cropSelect.addEventListener('change', ()=>{
    if(cropSelect.value) manualCropInput.value = ''; // Clear manual crop if dropdown selected
    fetchMarketPrices();
});

manualCropInput.addEventListener('input', ()=>{
    if(manualCropInput.value) cropSelect.value=''; // Clear dropdown if manual typed
});

// Unit change listener
document.getElementById('unit-select').addEventListener('change', fetchMarketPrices);

// Initialize
getAutoLocation();
</script>
</body>
</html>
