<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kerala & Tamil Nadu Farmers â€” Market Prices</title>
<style>
:root {
    --ivory: #FFFFF0;
    --olive: #556B2F;
    --shadow: 0 6px 18px rgba(0,0,0,0.12);
    --bg-color: linear-gradient(160deg, var(--ivory), #E8E7D8 30%, var(--olive) 100%);
    --frame-bg: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,240,0.96));
    --text-color: #333;
    --icon-btn-bg: rgba(255,255,255,0.9);
    --icon-color: var(--olive);
}

:root.dark-mode {
    --bg-color: linear-gradient(160deg, #1A1A1A, #282828 30%, #445a24 100%);
    --frame-bg: linear-gradient(180deg, rgba(30,30,30,0.9), rgba(40,40,40,0.96));
    --text-color: #F0F0F0;
    --icon-btn-bg: rgba(60,60,60,0.9);
    --icon-color: #e6f7d5;
}

body {
    margin:0; padding:0;
    display:flex; justify-content:center; align-items:flex-start;
    min-height:100vh;
    background: var(--bg-color);
    transition: background 0.3s, color 0.3s;
}
#phone-frame {
    width: 375px; background: var(--frame-bg);
    border-radius: 40px; box-shadow: var(--shadow);
    overflow:hidden; padding-bottom:20px;
    transition: background 0.3s;
}
header {
    display:flex; align-items:center; padding:15px;
    background: var(--frame-bg); position:sticky; top:0; z-index:10;
}
header h1 { margin:0; font-size:20px; color:var(--text-color); flex:1; text-align:center;}
.screen-content { padding:15px; color: var(--text-color);}
.info-card { background: var(--icon-btn-bg); padding:15px; border-radius:20px; text-align:center; margin-bottom:15px; transition: background 0.3s;}
.info-card h2 { margin:0 0 5px; }
.info-card p { margin:0; font-size:0.9em;}
label { display:block; margin-top:10px; font-size:0.9em;}
input, select, button { width:100%; padding:8px; margin-top:5px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; transition: background 0.3s, color 0.3s;}
button { background:var(--olive); color:white; cursor:pointer; border:none;}
button:hover { background:#6c8b46;}
.commodity-list { margin-top:15px; }
.commodity-item { background: var(--icon-btn-bg); padding:10px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 6px rgba(0,0,0,0.08); transition: background 0.3s;}
.commodity-item h4 { margin:0 0 5px; font-size:1em;}
.commodity-item p { margin:2px 0; font-size:0.85em;}
.input-group { display:flex; gap:5px; }
.input-group button { width:50px; padding:0; font-size:16px; }
.unit-select { margin-top:5px; }
#location-suggestions { border:1px solid #ccc; border-radius:5px; max-height:100px; overflow-y:auto; background:white; position:relative; z-index:5; transition: background 0.3s, color 0.3s;}
#location-suggestions div:hover { background:#f0f0f0; cursor:pointer; }
</style>
</head>
<body>
<div id="phone-frame">
    <header>
        <h1>Market Prices</h1>
        <!-- Optional: Dark Mode Toggle Button -->
        <button style="margin-left:5px; width:40px;" onclick="toggleDarkMode()">ðŸŒ“</button>
    </header>
    <div class="screen-content">
        <div class="info-card">
            <h2>ðŸŒ± Kerala & Tamil Nadu Farmers</h2>
            <p>Your companion for a thriving harvest</p>
        </div>

        <!-- Auto Location -->
        <label>Detected Location (Auto):</label>
        <div class="input-group">
            <input type="text" id="auto-location" readonly placeholder="Detecting...">
            <button onclick="getAutoLocation()">âŸ³</button>
        </div>

        <!-- Search for Location -->
        <label>Search for Location (Optional):</label>
        <input type="text" id="manual-location" placeholder="Type district/state">
        <div id="location-suggestions"></div>

        <!-- Crop Selection -->
        <label>Select Crop:</label>
        <select id="crop-select">
            <option value="">-- Select Crop --</option>
            <option>Chili Red</option>
            <option>Tomato</option>
            <option>Potato</option>
            <option>Onion</option>
            <option>Brinjal</option>
            <option>Cucumber</option>
            <option>Cabbage</option>
            <option>Cauliflower</option>
            <option>Okra</option>
            <option>Beans</option>
            <option>Spinach</option>
            <option>Banana</option>
            <option>Coconut</option>
            <option>Arecanut</option>
            <option>Papaya</option>
            <option>Mango</option>
            <option>Pineapple</option>
            <option>Turmeric</option>
            <option>Ginger</option>
        </select>

        <label>Or type crop name:</label>
        <div class="input-group">
            <input type="text" id="manual-crop" placeholder="Enter crop name">
            <button onclick="manualSetCrop()">âœ”</button>
        </div>

        <!-- Price Unit -->
        <label>Price Unit:</label>
        <select id="unit-select" class="unit-select">
            <option value="kg" selected>/kg</option>
            <option value="100kg">/100kg</option>
        </select>

        <!-- Market Prices -->
        <div class="commodity-list" id="commodity-prices">
            <p>Ready to search market data...</p>
        </div>
    </div>
</div>

<script>
const apiKey = '579b464db66ec23bdd0000017bef73f4f1bc4439694b32dbf0f004d8';
let currentState='', currentDistrict='';

// Tamil Nadu + Kerala districts
const govtLocations = [
    {state:"Tamil Nadu", district:"Ariyalur"}, {state:"Tamil Nadu", district:"Chengalpattu"},
    {state:"Tamil Nadu", district:"Chennai"}, {state:"Tamil Nadu", district:"Coimbatore"},
    {state:"Tamil Nadu", district:"Cuddalore"}, {state:"Tamil Nadu", district:"Dharmapuri"},
    {state:"Tamil Nadu", district:"Dindigul"}, {state:"Tamil Nadu", district:"Erode"},
    {state:"Tamil Nadu", district:"Kallakurichi"}, {state:"Tamil Nadu", district:"Kancheepuram"},
    {state:"Tamil Nadu", district:"Kanyakumari"}, {state:"Tamil Nadu", district:"Karur"},
    {state:"Tamil Nadu", district:"Krishnagiri"}, {state:"Tamil Nadu", district:"Madurai"},
    {state:"Tamil Nadu", district:"Nagapattinam"}, {state:"Tamil Nadu", district:"Namakkal"},
    {state:"Tamil Nadu", district:"Perambalur"}, {state:"Tamil Nadu", district:"Pudukkottai"},
    {state:"Tamil Nadu", district:"Ramanathapuram"}, {state:"Tamil Nadu", district:"Ranipet"},
    {state:"Tamil Nadu", district:"Salem"}, {state:"Tamil Nadu", district:"Sivaganga"},
    {state:"Tamil Nadu", district:"Tenkasi"}, {state:"Tamil Nadu", district:"Thanjavur"},
    {state:"Tamil Nadu", district:"Theni"}, {state:"Tamil Nadu", district:"Thoothukudi"},
    {state:"Tamil Nadu", district:"Tiruchirappalli"}, {state:"Tamil Nadu", district:"Tirunelveli"},
    {state:"Tamil Nadu", district:"Tirupattur"}, {state:"Tamil Nadu", district:"Tiruppur"},
    {state:"Tamil Nadu", district:"Tiruvallur"}, {state:"Tamil Nadu", district:"Tiruvannamalai"},
    {state:"Tamil Nadu", district:"Tiruvarur"}, {state:"Tamil Nadu", district:"Vellore"},
    {state:"Tamil Nadu", district:"Viluppuram"}, {state:"Tamil Nadu", district:"Virudhunagar"},
    {state:"Kerala", district:"Alappuzha"}, {state:"Kerala", district:"Ernakulam"}, {state:"Kerala", district:"Idukki"},
    {state:"Kerala", district:"Kannur"}, {state:"Kerala", district:"Kasaragod"}, {state:"Kerala", district:"Kollam"},
    {state:"Kerala", district:"Kottayam"}, {state:"Kerala", district:"Kozhikode"}, {state:"Kerala", district:"Malappuram"},
    {state:"Kerala", district:"Palakkad"}, {state:"Kerala", district:"Pathanamthitta"}, {state:"Kerala", district:"Thiruvananthapuram"},
    {state:"Kerala", district:"Thrissur"}, {state:"Kerala", district:"Wayanad"}
];

// Auto Location Detection
async function getAutoLocation() {
    const autoInput = document.getElementById('auto-location');
    autoInput.value = 'Detecting...';
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(async pos=>{
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await res.json();
                const district = data.address.county || data.address.city || '';
                const state = data.address.state || '';
                if(district && state){
                    autoInput.value = `${district}, ${state}`;
                    currentState = state; currentDistrict = district;
                    fetchMarketPrices();
                } else autoInput.value = 'Unable to detect';
            } catch(e){
                autoInput.value = 'Unable to detect';
            }
        }, err=>{
            autoInput.value = 'Unable to detect';
        });
    } else autoInput.value = 'Geolocation not supported';
}

// Manual Location Autocomplete
const manualLocationInput = document.getElementById('manual-location');
const suggestionBox = document.getElementById('location-suggestions');

manualLocationInput.addEventListener('input', ()=>{
    const query = manualLocationInput.value.trim().toLowerCase();
    suggestionBox.innerHTML = '';
    if(!query) return;

    const matches = govtLocations.filter(loc =>
        loc.state.toLowerCase().includes(query) || loc.district.toLowerCase().includes(query)
    ).slice(0, 5);

    matches.forEach(loc=>{
        const div = document.createElement('div');
        div.style.padding='5px';
        div.style.cursor='pointer';
        div.textContent = `${loc.district}, ${loc.state}`;
        div.onclick = ()=>{
            document.getElementById('auto-location').value = div.textContent;
            currentState = loc.state;
            currentDistrict = loc.district;
            suggestionBox.innerHTML='';
            manualLocationInput.value='';
            fetchMarketPrices();
        };
        suggestionBox.appendChild(div);
    });
});

// Hide suggestion box when clicking outside
document.addEventListener('click', function(e){
    if(!manualLocationInput.contains(e.target)){
        suggestionBox.innerHTML = '';
    }
});

// Manual Crop
function manualSetCrop(){
    const val = document.getElementById('manual-crop').value.trim();
    if(!val) return alert('Enter a crop name');
    fetchMarketPrices();
}

// Fetch Market Prices
async function fetchMarketPrices(){
    const manualCrop = document.getElementById('manual-crop').value.trim();
    const selectedCrop = document.getElementById('crop-select').value;
    const crop = manualCrop || selectedCrop;
    if(!crop) return;

    const container = document.getElementById('commodity-prices');
    container.innerHTML = 'Loading...';

    const unit = document.getElementById('unit-select').value;
    let multiplier = 1;
    if(unit==='kg') multiplier=0.01;
    else if(unit==='100kg') multiplier=1;

    let url = `https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${apiKey}&format=json&limit=10`;
    url += `&filters[state.keyword]=${encodeURIComponent(currentState)}`;
    url += `&filters[district]=${encodeURIComponent(currentDistrict)}`;
    url += `&filters[commodity]=${encodeURIComponent(crop)}`;

    try {
        const res = await fetch(url);
        const data = await res.json();
        container.innerHTML = '';
        if(data.records && data.records.length){
            data.records.forEach(r=>{
                const div = document.createElement('div');
                div.className='commodity-item';
                const min = r.min_price ? Math.round(r.min_price*multiplier) : 'N/A';
                const max = r.max_price ? Math.round(r.max_price*multiplier) : 'N/A';
                const modal = r.modal_price ? Math.round(r.modal_price*multiplier) : 'N/A';
                div.innerHTML = `
                    <h4>${r.commodity} - ${r.market}</h4>
                    <p>Date: ${r.arrival_date}</p>
                    <p>Min Price: â‚¹${min} ${unit}</p>
                    <p>Max Price: â‚¹${max} ${unit}</p>
                    <p>Modal Price: â‚¹${modal} ${unit}</p>
                `;
                container.appendChild(div);
            });
        } else container.innerHTML = '<p>No market data found.</p>';
    } catch(e){
        container.innerHTML='<p>Error fetching market data.</p>';
    }
}

// Crop dropdown + manual sync
const cropSelect = document.getElementById('crop-select');
const manualCropInput = document.getElementById('manual-crop');

cropSelect.addEventListener('change', ()=>{
    if(cropSelect.value) manualCropInput.value = '';
    fetchMarketPrices();
});

manualCropInput.addEventListener('input', ()=>{
    if(manualCropInput.value) cropSelect.value='';
});

// Unit change listener
document.getElementById('unit-select').addEventListener('change', fetchMarketPrices);

// Initialize default unit and auto location
document.getElementById('unit-select').value = 'kg';
getAutoLocation();

// Dark mode toggle
function toggleDarkMode(){
    const isDark = document.documentElement.classList.toggle('dark-mode');
    localStorage.setItem('dark-mode', isDark);
}

// Load saved dark mode preference
if(localStorage.getItem('dark-mode') === 'true'){
    document.documentElement.classList.add('dark-mode');
}
</script>
</body>
</html>
