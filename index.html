<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title data-key="appName">Kerala Farmers — Mobile UI</title>
<style>
:root {
    --ivory: #FFFFF0;
    --olive: #556B2F;
    --shadow: 0 6px 18px rgba(0,0,0,0.12);
    font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html, body {
    height: 100%;
    margin: 0;
    background: linear-gradient(160deg, var(--ivory), #E8E7D8 30%, var(--olive) 100%);
    overflow: hidden;
}

body {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.phone-frame {
    /* Desktop/Tablet Styles */
    width: 98vw;
    height: 98vh;
    max-width: 420px;
    max-height: 850px;
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,240,0.96));
    border-radius: 28px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    position: relative;
    padding: 2vmin;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: all 0.4s ease;
}

/* --- Media query for mobile devices --- */
@media (max-width: 480px) {
    body {
        padding: 0;
        align-items: stretch;
        justify-content: flex-start;
    }
    .phone-frame {
        width: 100vw;
        height: 100vh;
        max-width: none;
        max-height: none;
        border-radius: 0;
        box-shadow: none;
        padding: 0;
    }
    .top-row {
        padding: 6vmin 4vmin 2.5vmin;
    }
    .content {
        padding: 2.5vmin 4vmin;
    }
    .ai-panel {
        padding: 4vmin 4vmin 2vmin;
    }
    .ai-output-container {
        padding-bottom: 1vmin;
    }
    .ai-header {
        margin-bottom: 2vmin;
    }
}

.top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1vmin;
    gap: 2vmin;
    transition: all 0.4s ease;
}

.weather-box {
    background: linear-gradient(90deg, rgba(255,255,240,0.9), rgba(200,210,170,0.12));
    color: #333;
    padding: 2vmin 3vmin;
    border-radius: 14px;
    font-weight: 600;
    box-shadow: var(--shadow);
    min-width: 18vmin;
    text-transform: lowercase;
    letter-spacing: 0.6px;
    display: flex;
    flex-direction: column;
    font-size: 0.9em;
    gap: 1vmin;
}

.weather-box .city-name {
    font-size: 0.8em;
    opacity: 0.8;
    text-transform: capitalize;
    letter-spacing: 0;
}

.top-right {
    display: flex;
    align-items: center;
    gap: 2vmin;
}

.icon-btn {
    border: none;
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
    padding: 2vmin;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    touch-action: manipulation;
}

.icon-btn svg {
    color: var(--olive);
    width: 6vmin;
    height: 6vmin;
}

.content {
    display: flex;
    flex-direction: column;
    gap: 2vmin;
    align-items: stretch;
    padding: 1vmin;
    flex: 1;
}

/* --- NEW: Enlarged News Bar CSS --- */
.news-bar {
    width: 100%;
    background-color: #e6f7d5;
    color: #556B2F;
    padding: 3vmin 4vmin; /* Increased padding */
    font-size: 4vmin;    /* Increased font size */
    font-weight: 600;
    overflow: hidden;
    position: relative;
    border-radius: 18px; /* Slightly larger radius */
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    margin-bottom: 2vmin; /* Add some spacing below */
}
.news-text {
    display: inline-block;
    white-space: nowrap;
    animation: marquee 20s linear infinite; /* Adjusted speed for longer text */
    padding-left: 100%;
}
@keyframes marquee {
    0% { transform: translateX(0%); }
    100% { transform: translateX(-100%); }
}

.carousel-wrapper {
    display: flex;
    align-items: center;
    gap: 2vmin;
    justify-content: center;
}

.arrow {
    background: transparent;
    border: 1px solid rgba(0,0,0,0.06);
    width: 8vmin;
    height: 8vmin;
    border-radius: 10px;
    font-size: 4vmin;
    cursor: pointer;
    touch-action: manipulation;
}

.carousel {
    display: flex;
    gap: 3vmin;
    overflow-x: scroll;
    width: 100%;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding: 1vmin 0;
}

.card {
    min-width: 78%;
    max-width: 78%;
    height: 44vh;
    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,245,0.9));
    border-radius: 16px;
    padding: 4vmin;
    box-shadow: var(--shadow);
    scroll-snap-align: center;
    display: flex;
    flex-direction: column;
    gap: 1vmin;
    align-items: flex-start;
    justify-content: center;
    text-align: left;
}

.card h2 {
    margin: 0;
    font-size: 4vmin;
    color: var(--olive);
}

.card p {
    margin: 0;
    color: #444;
}

.dots {
    display: flex;
    gap: 2vmin;
    justify-content: center;
    align-items: center;
    margin-top: 2vmin;
}

.dots .dot {
    width: 2vmin;
    height: 2vmin;
    border-radius: 999px;
    background: rgba(0,0,0,0.12);
}

.dots .dot.active {
    width: 2.5vmin;
    height: 2.5vmin;
    background: var(--olive);
}

.search-row {
    display: flex;
    align-items: center;
    gap: 2vmin;
    padding: 1vmin;
}

.search-input {
    flex: 1;
    padding: 3vmin 4vmin;
    font-size: 3.5vmin;
    border-radius: 12px;
    border: none;
    box-shadow: 0 6px 16px rgba(0,0,0,0.06);
    outline: none;
    background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(245,245,240,0.9));
}

.icon-btn.gallery, .icon-btn.mic {
    padding: 2vmin;
    border-radius: 10px;
    background: transparent;
}

.send-btn {
    background: var(--olive);
    color: white;
    border: none;
    border-radius: 12px;
    padding: 3vmin 5vmin;
    font-size: 3.5vmin;
    font-weight: 600;
    cursor: pointer;
    min-width: 15vmin;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.send-btn:active {
    background: #445a24;
    transform: scale(0.96);
}

.bottom-nav {
    display: flex;
    align-items: center;
    justify-content: space-around;
    gap: 2vmin;
    padding: 2vmin 1vmin;
    border-top: 1px solid rgba(0,0,0,0.03);
}

.nav-btn {
    border: none;
    background: transparent;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1vmin;
    font-size: 3vmin;
    color: #333;
    cursor: pointer;
}

.nav-btn svg {
    width: 6vmin;
    height: 6vmin;
    color: var(--olive);
}

.camera-btn {
    width: 15vmin;
    height: 15vmin;
    border-radius: 999px;
    background: linear-gradient(180deg, var(--olive), #6c8b46);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: 0 10px 20px rgba(0,0,0,0.18);
    transform: translateY(-18%);
    border: 4px solid rgba(255,255,255,0.6);
}

.camera-btn svg {
    width: 6.5vmin;
    height: 6.5vmin;
    color: white;
}

/* --- Panel Styles --- */
.ai-panel {
    position: absolute;
    top: 0;
    right: -100vw;
    width: 100%;
    height: 100%;
    background: #fff;
    border-radius: 28px;
    box-shadow: var(--shadow);
    transition: right 0.4s ease;
    display: flex;
    flex-direction: column;
    padding: 4vmin;
    z-index: 10;
}

.ai-panel.active {
    right: 0;
}

.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4vmin;
}

.ai-header h3 {
    margin: 0;
    color: var(--olive);
    font-size: 5vmin;
    flex-grow: 1;
    text-align: center;
    padding: 0 4vmin;
}

.ai-header .new-chat-btn {
    background: #e0e0e0;
    border: none;
    border-radius: 12px;
    padding: 1.5vmin 3vmin;
    font-size: 2.5vmin;
    cursor: pointer;
    color: #333;
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

.ai-header .new-chat-btn:hover {
    opacity: 1;
}

.ai-header .new-chat-btn:active {
    transform: scale(0.96);
}

.ai-header .close-btn {
    background: rgba(0,0,0,0.05);
    border: none;
    border-radius: 50%;
    padding: 2vmin;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.ai-header .close-btn svg {
    width: 5vmin;
    height: 5vmin;
    color: #333;
}
.ai-output-container {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 2vmin;
    padding: 2vmin;
    -webkit-overflow-scrolling: touch;
}

.chat-bubble {
    padding: 3vmin 4vmin;
    border-radius: 12px;
    max-width: 80%;
    line-height: 1.4;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    position: relative;
    white-space: pre-wrap;
    word-wrap: break-word;
}
.chat-bubble.user {
    background: var(--olive);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}
.chat-bubble.ai {
    background: #f0f0f0;
    color: #333;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.thinking-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 2vmin;
    margin: 4vmin 0 2vmin;
}

.thinking-dots .dot {
    width: 2.5vmin;
    height: 2.5vmin;
    background-color: var(--olive);
    border-radius: 50%;
    opacity: 0.2;
    animation: blink 1.4s infinite;
}

.thinking-dots .dot:nth-child(2) {
    animation-delay: 0.2s;
}

.thinking-dots .dot:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes blink {
    0%, 100% { transform: scale(0.8); opacity: 0.2; }
    20% { transform: scale(1.2); opacity: 1; }
    40% { transform: scale(0.8); opacity: 0.2; }
}

.ai-panel .cancel-btn {
    position: absolute;
    bottom: 4vmin;
    left: 50%;
    transform: translateX(-50%);
    background-color: #f44336;
    color: white;
    border: none;
    padding: 2.5vmin 5vmin;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: opacity 0.3s ease;
    opacity: 0;
    visibility: hidden;
    z-index: 11;
}

.ai-panel.active .cancel-btn.show {
    opacity: 1;
    visibility: visible;
}

/* Info Popup Styles */
.info-popup {
    position: fixed;
    bottom: 12%;
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 2vmin 4vmin;
    border-radius: 12px;
    font-size: 3.5vmin;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0s 0.3s;
    z-index: 20;
    max-width: 80%;
    text-align: center;
}

.info-popup.show {
    opacity: 1;
    visibility: visible;
    transition: opacity 0.3s ease, visibility 0s;
}

/* --- Settings Panel Styles --- */
.settings-panel {
    position: absolute;
    top: 0;
    left: -100vw;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,240,0.96));
    border-radius: 28px;
    box-shadow: var(--shadow);
    transition: left 0.4s ease-in-out;
    display: flex;
    flex-direction: column;
    padding: 4vmin;
    z-index: 10;
}

.settings-panel.active {
    left: 0;
}

.settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4vmin;
}

.settings-header h3 {
    margin: 0;
    color: var(--olive);
    font-size: 5vmin;
    flex-grow: 1;
    text-align: center;
}

.settings-list {
    display: flex;
    flex-direction: column;
    gap: 2vmin;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 3vmin 0;
    border-bottom: 1px solid rgba(0,0,0,0.05);
}

.setting-item label {
    font-size: 4vmin;
    color: #333;
}

.language-select {
    font-size: 3.5vmin;
    padding: 1.5vmin 2.5vmin;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: white;
}

.developed-by {
    position: absolute;
    bottom: 8vmin;
    width: calc(100% - 8vmin);
    text-align: center;
    color: #888;
    font-size: 3vmin;
    letter-spacing: 0.5px;
}
</style>
</head>
<body>
<div class="phone-frame" id="phoneFrame">
    <div class="news-bar">
        <span class="news-text" id="newsBarText"></span>
    </div>
    <header class="top-row">
        <div class="weather-box" id="weatherBox">
            <span id="weatherTemp"></span>
            <span id="weatherCity" class="city-name" data-key="gettingLocation">Getting location</span>
        </div>
        <div class="top-right">
            <button class="icon-btn location" id="locationBtn" title="Location">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="var(--olive)">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="none" stroke="var(--olive)" stroke-width="2"/>
                </svg>
            </button>
        </div>
    </header>
    <main class="content">
        <div class="carousel-wrapper">
            <button class="arrow left">&larr;</button>
            <div class="carousel" id="carousel">
                <article class="card">
                    <h2 data-key="cropsTitle">Crops</h2>
                    <p data-key="cropsDescription">Crop info, tips and schedules.</p>
                </article>
                <article class="card">
                    <h2 data-key="marketPriceTitle">Market Price</h2>
                    <p data-key="marketPriceDescription">Latest prices from local markets.</p>
                </article>
                <article class="card">
                    <h2 data-key="chatBoxTitle">Chat Box</h2>
                    <p data-key="chatBoxDescription">AI assistant & conversation.</p>
                </article>
            </div>
            <button class="arrow right">&rarr;</button>
        </div>
        <div class="dots" id="dots"></div>
        <div class="search-row">
            <button id="galleryBtn" class="icon-btn gallery" title="Gallery">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="var(--olive)">
                    <rect x="3" y="4" width="18" height="16" fill="none" stroke="var(--olive)" stroke-width="2"/>
                    <circle cx="8" cy="8" r="1.5"/>
                    <path d="M3 20l4-5 5 6 7-9 5 7" fill="none" stroke="var(--olive)" stroke-width="2"/>
                </svg>
            </button>
            <input id="searchInput" class="search-input" type="search" data-key="askAI" placeholder="Ask AI..."/>
            <button id="micBtn" class="icon-btn mic" title="Voice">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="var(--olive)">
                    <path d="M12 14a3 3 0 0 0 3-3V5a3 3 0 0 0-6 0v6a3 3 0 0 0 3 3z"/>
                    <path d="M5 11a7 7 0 0 0 14 0" fill="none" stroke="var(--olive)" stroke-width="2"/>
                    <line x1="12" y1="17" x2="12" y2="21" stroke="var(--olive)" stroke-width="2"/>
                    <line x1="8" y1="21" x2="16" y2="21" stroke="var(--olive)" stroke-width="2"/>
                </svg>
            </button>
            <button id="sendBtn" class="send-btn" data-key="send">Send</button>
        </div>
    </main>
    <nav class="bottom-nav">
        <button class="nav-btn" id="settingsBtn">
            <svg viewBox="0 0 24 24" width="24" height="24">
                <path fill="currentColor" d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm0 2a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
                <path fill="currentColor" d="M22.25 10.96a.75.75 0 0 0-.61-.9c-1.3-.28-2.61-.7-3.8-1.28l-1.42-.65a.75.75 0 0 0-.96.22l-1.47 2.05a.75.75 0 0 0 .23.96c.64.4.89.54 1.4.92.51.37.93.81 1.25 1.34a.75.75 0 0 0 .19.89l.86 1.05a.75.75 0 0 0 .96.25c1.19-.58 2.5-1.02 3.8-1.3a.75.75 0 0 0 .6-.9zm-6.04 7.64a.75.75 0 0 0-.9-.61c-1.3.28-2.61.7-3.8 1.28l-1.42.65a.75.75 0 0 0-.96-.22l-1.47-2.05a.75.75 0 0 0 .23-.96c.64-.4.89-.54 1.4-.92.51-.37.93-.81 1.25-1.34a.75.75 0 0 0 .19-.89l.86-1.05a.75.75 0 0 0-.96-.25c-1.19.58-2.5 1.02-3.8 1.3a.75.75 0 0 0-.6.9zm-8.8-7.65a.75.75 0 0 0 .61.9c1.3.28 2.61.7 3.8 1.28l1.42.65a.75.75 0 0 0 .96-.22l1.47-2.05a.75.75 0 0 0-.23-.96c-.64-.4-.89-.54-1.4-.92-.51-.37-.93-.81-1.25-1.34a.75.75 0 0 0-.19-.89l-.86-1.05a.75.75 0 0 0-.96-.25c-1.19.58-2.5 1.02-3.8 1.3a.75.75 0 0 0-.6.9zM7.3 16.64a.75.75 0 0 0 .9.61c1.3-.28 2.61-.7 3.8-1.28l1.42-.65a.75.75 0 0 0 .96.22l1.47 2.05a.75.75 0 0 0-.23.96c-.64.4-.89.54-1.4.92-.51.37-.93.81-1.25 1.34a.75.75 0 0 0-.19.89l-.86 1.05a.75.75 0 0 0-.96.25c-1.19-.58-2.5-1.02-3.8-1.3a.75.75 0 0 0-.6-.9z"/>
            </svg>
            <span data-key="settings">Settings</span>
        </button>
        <button id="cameraBtn" class="camera-btn">
            <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm0-5c-1.1 0-2 .9-2 2H8l-2 2H4c-1.1 0-2 .9-2 2v10a2 2 0 0 0 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-2l-2-2h-2c0-1.1-.9-2-2-2z"/></svg>
        </button>
        <button class="nav-btn" id="aiNavBtn">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M21 6.75V15h-4.5V6.75H21Zm-6-4.5V9h-4.5V2.25H15ZM9 9v6.75H2.25V9H9Zm0 6.75V21H2.25V15.75H9Zm6 0V21H9.75V15.75H15Zm6 0V21H15.75V15.75H21Zm-6-6V15h-4.5V9H15Zm0-6.75V9h-4.5V2.25H15Z"/>
            </svg>
            <span data-key="ai">AI</span>
        </button>
    </nav>
    <input type="file" id="fileInput" accept="image/*" style="display:none" />
    <section class="ai-panel" id="aiPanel">
        <div class="ai-header">
            <button id="newChatBtn" class="new-chat-btn" data-key="newChat">New Chat</button>
            <h3 data-key="aiAssistant">AI Assistant</h3>
            <button id="closeAiBtn" class="close-btn" title="Close">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
        </div>
        <div id="aiOutput" class="ai-output-container">
            </div>
        <button id="cancelBtn" class="cancel-btn" data-key="cancel">Cancel</button>
    </section>
    <section class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <button id="closeSettingsBtn" class="close-btn" title="Close">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </button>
            <h3 data-key="settings">Settings</h3>
        </div>
        <div class="settings-list">
            <div class="setting-item">
                <label for="language-select" data-key="language">Language</label>
                <select id="language-select" class="language-select">
                    <option value="en">English</option>
                    <option value="ml">Malayalam</option>
                    <option value="hi">Hindi</option>
                    <option value="ta">Tamil</option>
                </select>
            </div>
        </div>
        <div class="developed-by" data-key="developedBy">
            Developed by Team Azura
        </div>
    </section>
    <div id="infoPopup" class="info-popup"></div>
</div>

<script>
    // Constants for API URLs
    const OPEN_METEO_API = "https://api.open-meteo.com/v1/forecast";
    const BIGDATACLOUD_API = "https://api.bigdatacloud.net/data/reverse-geocode-client";
    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=";

    // IMPORTANT: Paste your actual Gemini API key here.
    // WARNING: Storing the API key in client-side code is a major security risk.
    // For a production app, you MUST use a server-side proxy to keep your key secure.
    const apiKey = "AIzaSyD7GhzxjmiKWj8MUCMyIRXlVUiSwwVOp1w";

    // --- UI Element References ---
    const phoneFrame = document.getElementById("phoneFrame");
    const aiPanel = document.getElementById("aiPanel");
    const settingsPanel = document.getElementById("settingsPanel");
    const aiOutput = document.getElementById("aiOutput");
    const searchInput = document.getElementById("searchInput");
    const sendBtn = document.getElementById("sendBtn");
    const galleryBtn = document.getElementById("galleryBtn");
    const fileInput = document.getElementById("fileInput");
    const micBtn = document = document.getElementById("micBtn");
    const cameraBtn = document.getElementById("cameraBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const locationBtn = document.getElementById("locationBtn");
    const weatherTempSpan = document.getElementById("weatherTemp");
    const weatherCitySpan = document.getElementById("weatherCity");
    const infoPopup = document.getElementById("infoPopup");
    const aiNavBtn = document.getElementById("aiNavBtn");
    const newChatBtn = document.getElementById("newChatBtn");
    const closeAiBtn = document.getElementById("closeAiBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");
    const languageSelect = document.getElementById("language-select");
    const newsBarText = document.getElementById("newsBarText");

    // --- State Variables ---
    let currentAbortController = null;
    let popupTimeout = null;
    let currentLanguage = localStorage.getItem('language') || 'en';
    let chatHistory = [];
    let isFetching = false;

    // --- Swipe gesture state variables ---
    let startX = 0;
    const swipeThreshold = 50;

    // --- Translations Object ---
    const translations = {
        en: {
            appName: "Kerala Farmers — Mobile UI",
            gettingLocation: "Getting location",
            settings: "Settings",
            ai: "AI",
            newChat: "New Chat",
            aiAssistant: "AI Assistant",
            greeting: "Hello! How can I assist you with your farming needs today?",
            cancel: "Cancel",
            language: "Language",
            developedBy: "Developed by Team Azura",
            askAI: "Ask AI...",
            cropsTitle: "Crops",
            cropsDescription: "Crop info, tips and schedules.",
            marketPriceTitle: "Market Price",
            marketPriceDescription: "Latest prices from local markets.",
            chatBoxTitle: "Chat Box",
            chatBoxDescription: "AI assistant & conversation.",
            listening: "Listening...",
            voiceInputFailed: "Voice input failed.",
            listeningStopped: "Listening stopped.",
            pleaseWait: "Please wait for the current response.",
            requestCanceled: "Request canceled.",
            oopsSomethingWentWrong: "Oops, something went wrong. Please try again.",
            newChatStarted: "New chat started.",
            geolocationNotSupported: "Geolocation not supported.",
            tryAgain: "try again",
            send: "Send",
            analyzeImage: "Analyze this image",
            news: "Welcome to the Kerala Farmers App! | Weather and crop advisories for the next 7 days. | New government subsidies are now available. | Check out the latest market prices for your harvest. | Pest and disease alerts for coconut palms. | Click on the AI assistant to ask any question!"
        },
        ml: {
            appName: "കേരള കർഷകർ — മൊബൈൽ യുഐ",
            gettingLocation: "ലൊക്കേഷൻ കണ്ടെത്തുന്നു",
            settings: "ക്രമീകരണങ്ങൾ",
            ai: "എ.ഐ.",
            newChat: "പുതിയ സംഭാഷണം",
            aiAssistant: "എ.ഐ. അസിസ്റ്റന്റ്",
            greeting: "ഹായ്! നിങ്ങളുടെ കാർഷിക ആവശ്യങ്ങളിൽ ഞാൻ എങ്ങനെ സഹായിക്കും?",
            cancel: "റദ്ദാക്കുക",
            language: "ഭാഷ",
            developedBy: "ടീം അസൂറ വികസിപ്പിച്ചത്",
            askAI: "എ.ഐ.യോട് ചോദിക്കുക...",
            cropsTitle: "വിളകൾ",
            cropsDescription: "വിള വിവരങ്ങൾ, നുറുങ്ങുകൾ, ഷെഡ്യൂളുകൾ.",
            marketPriceTitle: "വിപണി വില",
            marketPriceDescription: "പ്രാദേശിക മാർക്കറ്റുകളിൽ നിന്നുള്ള ഏറ്റവും പുതിയ വിലകൾ.",
            chatBoxTitle: "ചാറ്റ് ബോക്സ്",
            chatBoxDescription: "എ.ഐ. അസിസ്റ്റന്റ് & സംഭാഷണം.",
            listening: "കേൾക്കുന്നു...",
            voiceInputFailed: "വോയിസ് ഇൻപുട്ട് പരാജയപ്പെട്ടു.",
            listeningStopped: "കേൾക്കുന്നത് നിർത്തി.",
            pleaseWait: "ദയവായി നിലവിലെ പ്രതികരണത്തിനായി കാത്തിരിക്കുക.",
            requestCanceled: "അഭ്യർത്ഥന റദ്ദാക്കി.",
            oopsSomethingWentWrong: "ക്ഷമിക്കണം, എന്തോ പിഴവ് സംഭവിച്ചു. വീണ്ടും ശ്രമിക്കുക.",
            newChatStarted: "പുതിയ സംഭാഷണം ആരംഭിച്ചു.",
            geolocationNotSupported: "ജിയോലൊക്കേഷൻ പിന്തുണയ്ക്കുന്നില്ല.",
            tryAgain: "വീണ്ടും ശ്രമിക്കുക",
            send: "അയക്കുക",
            analyzeImage: "ഈ ചിത്രം വിശകലനം ചെയ്യുക",
            news: "കേരള കർഷക ആപ്പിലേക്ക് സ്വാഗതം! | അടുത്ത 7 ദിവസത്തേക്കുള്ള കാലാവസ്ഥാ, വിള ഉപദേശങ്ങൾ. | പുതിയ സർക്കാർ സബ്സിഡികൾ ലഭ്യമാണ്. | നിങ്ങളുടെ വിളകൾക്കുള്ള ഏറ്റവും പുതിയ വിപണി വിലകൾ പരിശോധിക്കുക. | തെങ്ങുകൾക്കുള്ള കീട, രോഗ മുന്നറിയിപ്പുകൾ. | ഏത് ചോദ്യവും ചോദിക്കാൻ എ.ഐ. അസിസ്റ്റൻ്റിൽ ക്ലിക്ക് ചെയ്യുക!"
        },
        hi: {
            appName: "केरल किसान — मोबाइल यूआई",
            gettingLocation: "स्थान प्राप्त हो रहा है",
            settings: "सेटिंग्स",
            ai: "एआई",
            newChat: "नई चैट",
            aiAssistant: "एआई सहायक",
            greeting: "नमस्ते! मैं आपकी कृषि संबंधी जरूरतों में कैसे मदद कर सकता हूँ?",
            cancel: "रद्द करें",
            language: "भाषा",
            developedBy: "टीम अज़ुरा द्वारा विकसित",
            askAI: "एआई से पूछें...",
            cropsTitle: "फसलें",
            cropsDescription: "फसल की जानकारी, सुझाव और शेड्यूल।",
            marketPriceTitle: "बाज़ार मूल्य",
            marketPriceDescription: "स्थानीय बाज़ारों से नवीनतम कीमतें।",
            chatBoxTitle: "चैट बॉक्स",
            chatBoxDescription: "एआई सहायक और बातचीत।",
            listening: "सुन रहा है...",
            voiceInputFailed: "ध्वनि इनपुट विफल रहा।",
            listeningStopped: "सुनना बंद हो गया।",
            pleaseWait: "कृपया वर्तमान प्रतिक्रिया की प्रतीक्षा करें।",
            requestCanceled: "अनुरोध रद्द किया गया।",
            oopsSomethingWentWrong: "अरे नहीं, कुछ गलत हो गया। कृपया पुन: प्रयास करें।",
            newChatStarted: "नई चैट शुरू हुई।",
            geolocationNotSupported: "जियोलोकेशन समर्थित नहीं है।",
            tryAgain: "पुनः प्रयास करें",
            send: "भेजें",
            analyzeImage: "इस छवि का विश्लेषण करें",
            news: "केरल किसान ऐप में आपका स्वागत है! | अगले 7 दिनों के लिए मौसम और फसल सलाह। | नई सरकारी सब्सिडी अब उपलब्ध हैं। | अपनी फसल के लिए नवीनतम बाज़ार कीमतों की जाँच करें। | नारियल के पेड़ों के लिए कीट और रोग अलर्ट। | कोई भी प्रश्न पूछने के लिए एआई सहायक पर क्लिक करें!"
        },
        ta: {
            appName: "கேரளா விவசாயிகள் — மொபைல் யுஐ",
            gettingLocation: "இருப்பிடம் பெறுகிறது",
            settings: "அமைப்புகள்",
            ai: "ஏஐ",
            newChat: "புதிய அரட்டை",
            aiAssistant: "ஏஐ உதவியாளர்",
            greeting: "வணக்கம்! உங்கள் விவசாய தேவைகளுக்கு நான் எப்படி உதவ முடியும்?",
            cancel: "ரத்து செய்",
            language: "மொழி",
            developedBy: "டீம் அசுரா மூலம் உருவாக்கப்பட்டது",
            askAI: "ஏஐ-யிடம் கேளுங்கள்...",
            cropsTitle: "பயிர்கள்",
            cropsDescription: "பயிர் தகவல், குறிப்புகள் மற்றும் அட்டவணைகள்.",
            marketPriceTitle: "சந்தை விலை",
            marketPriceDescription: "உள்ளூர் சந்தைகளிலிருந்து சமீபத்திய விலைகள்.",
            chatBoxTitle: "அரட்டை பெட்டி",
            chatBoxDescription: "ஏஐ உதவியாளர் மற்றும் உரையாடல்.",
            listening: "கேட்டுக் கொண்டிருக்கிறது...",
            voiceInputFailed: "குரல் உள்ளீடு தோல்வியடைந்தது.",
            listeningStopped: "கேட்பது நிறுத்தப்பட்டது.",
            pleaseWait: "தற்போதைய பதிலுக்காக காத்திருக்கவும்.",
            requestCanceled: "கோரிக்கை ரத்து செய்யப்பட்டது.",
            oopsSomethingWentWrong: "மன்னிக்கவும், ஏதோ தவறு நடந்தது. மீண்டும் முயற்சிக்கவும்.",
            newChatStarted: "புதிய அரட்டை தொடங்கப்பட்டது.",
            geolocationNotSupported: "புவிஇருப்பிடம் ஆதரிக்கப்படவில்லை.",
            tryAgain: "மீண்டும் முயலுங்கள்",
            send: "அனுப்பு",
            analyzeImage: "இந்த படத்தை பகுப்பாய்வு செய்யவும்",
            news: "கேரளா விவசாயிகள் பயன்பாட்டிற்கு வரவேற்கிறோம்! | அடுத்த 7 நாட்களுக்கான வானிலை மற்றும் பயிர் ஆலோசனைகள். | புதிய அரசு மானியங்கள் இப்போது கிடைக்கின்றன. | உங்கள் அறுவடைக்கான சமீபத்திய சந்தை விலைகளை சரிபார்க்கவும். | தென்னை மரங்களுக்கான பூச்சி மற்றும் நோய் எச்சரிக்கைகள். | எந்த கேள்வியும் கேட்க ஏஐ உதவியாளரைக் கிளிக் செய்யவும்!"
        }
    };

    // --- Language Translation Function ---
    function updateLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('language', lang);

        const elementsToTranslate = document.querySelectorAll('[data-key]');
        elementsToTranslate.forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[lang] && translations[lang][key]) {
                if (el.tagName === 'INPUT' && el.type === 'search') {
                    el.placeholder = translations[lang][key];
                } else {
                    el.textContent = translations[lang][key];
                }
            }
        });
        
        document.title = translations[lang].appName;
        newsBarText.textContent = translations[lang].news;

        // Corrected: Reset chat history immediately to show the new greeting
        resetChatHistory();
    }

    function resetChatHistory() {
        chatHistory = [{
            role: "model",
            parts: [{ text: translations[currentLanguage].greeting }]
        }];
        renderChat();
    }

    // --- Panel Control Functions ---
    function openAI() {
        aiPanel.classList.add("active");
    }

    function closeAI() {
        aiPanel.classList.remove("active");
        if (currentAbortController) {
            currentAbortController.abort();
            currentAbortController = null;
        }
    }

    function openSettings() {
        settingsPanel.classList.add("active");
    }

    function closeSettings() {
        settingsPanel.classList.remove("active");
    }

    // --- Info Popup Function ---
    function showInfoPopup(messageKey) {
        clearTimeout(popupTimeout);
        const translatedMessage = translations[currentLanguage][messageKey] || messageKey;
        infoPopup.innerText = translatedMessage;
        infoPopup.classList.add('show');
        popupTimeout = setTimeout(() => {
            infoPopup.classList.remove('show');
        }, 3000);
    }

    // --- Chat Rendering Functions ---
    function renderChat() {
        aiOutput.innerHTML = '';
        chatHistory.forEach(message => {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', message.role);
            if (message.parts.some(p => p.inlineData)) {
                 bubble.innerHTML = message.parts.map(p => {
                    if (p.text) return `<p>${p.text}</p>`;
                    if (p.inlineData) return `<img src="data:${p.inlineData.mimeType};base64,${p.inlineData.data}" style="max-width:100%; border-radius:12px;">`;
                    return '';
                 }).join('');
            } else {
                bubble.innerText = message.parts[0].text;
            }
            aiOutput.appendChild(bubble);
        });
        aiOutput.scrollTop = aiOutput.scrollHeight;
    }

    // --- AI Integration Functions ---
    async function callAI(prompt, imageFile = null) {
        if (isFetching) {
            showInfoPopup("pleaseWait");
            return;
        }

        isFetching = true;
        cancelBtn.classList.add('show');

        const userMessage = {
            role: "user",
            parts: [{ text: prompt }]
        };

        if (imageFile) {
            userMessage.parts.push({
                inlineData: {
                    mimeType: imageFile.type,
                    data: await new Promise(resolve => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.readAsDataURL(imageFile);
                    })
                }
            });
        }
        chatHistory.push(userMessage);
        renderChat();
        searchInput.value = "";
        openAI();

        const thinkingBubble = document.createElement('div');
        thinkingBubble.classList.add('chat-bubble', 'ai');
        thinkingBubble.innerHTML = `
            <div class="thinking-dots">
                <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
        `;
        aiOutput.appendChild(thinkingBubble);
        aiOutput.scrollTop = aiOutput.scrollHeight;

        const payload = {
            contents: chatHistory,
        };

        currentAbortController = new AbortController();
        const { signal } = currentAbortController;

        try {
            const response = await fetch(GEMINI_API_URL + apiKey, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                signal: signal
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
            }

            const data = await response.json();
            const responseText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received. Please try again.";

            aiOutput.removeChild(thinkingBubble);
            const aiMessage = {
                role: "model",
                parts: [{ text: responseText }]
            };
            chatHistory.push(aiMessage);
            renderChat();
        } catch (err) {
            if (err.name === 'AbortError') {
                showInfoPopup("requestCanceled");
            } else {
                console.error("AI API Error:", err);
                showInfoPopup("oopsSomethingWentWrong");
            }
            if (aiOutput.contains(thinkingBubble)) {
                aiOutput.removeChild(thinkingBubble);
            }
        } finally {
            cancelBtn.classList.remove('show');
            currentAbortController = null;
            isFetching = false;
        }
    }

    // --- Weather and Location Functions ---
    async function updateLocationAndWeather() {
        weatherTempSpan.textContent = "...";
        weatherCitySpan.textContent = translations[currentLanguage].gettingLocation;

        if (!navigator.geolocation) {
            weatherTempSpan.textContent = "Error";
            weatherCitySpan.textContent = translations[currentLanguage].geolocationNotSupported;
            return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
            try {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const weatherRes = await fetch(`${OPEN_METEO_API}?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const weatherData = await weatherRes.json();
                if (weatherData.current_weather) {
                    weatherTempSpan.textContent = `${Math.round(weatherData.current_weather.temperature)}°C`;
                }

                const geoRes = await fetch(`${BIGDATACLOUD_API}?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                const geoData = await geoRes.json();
                if (geoData.city) {
                    weatherCitySpan.textContent = geoData.city;
                }
            } catch (err) {
                console.error("Location/Weather Error:", err);
                weatherTempSpan.textContent = "Error";
                weatherCitySpan.textContent = translations[currentLanguage].tryAgain;
            }
        }, (err) => {
            console.error("Geolocation Error:", err);
            weatherTempSpan.textContent = "Error";
            weatherCitySpan.textContent = translations[currentLanguage].tryAgain;
        });
    }

    // --- Event Listeners ---
    document.addEventListener("DOMContentLoaded", () => {
        const savedLanguage = localStorage.getItem('language');
        if (savedLanguage) {
            currentLanguage = savedLanguage;
            languageSelect.value = savedLanguage;
        }
        
        // Initialize chat history and UI with the correct language
        updateLanguage(currentLanguage);
        updateLocationAndWeather();
        createDots();
        scrollToIndex(0);
    });

    sendBtn.addEventListener("click", () => {
        const value = searchInput.value.trim();
        if (value) {
            callAI(value);
        }
    });

    searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendBtn.click();
        }
    });

    galleryBtn.addEventListener("click", () => {
        fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
            callAI(translations[currentLanguage].analyzeImage || "Analyze this image", file);
        }
    });

    micBtn.addEventListener("click", () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = "en-US";
            recognition.interimResults = false;
            showInfoPopup("listening");
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript;
                callAI(transcript);
            };
            recognition.onerror = (e) => {
                console.error("Speech Recognition Error:", e.error);
                showInfoPopup("voiceInputFailed");
            };
            recognition.onend = () => {
                 showInfoPopup("listeningStopped");
            }
            recognition.start();
        } else {
            showInfoPopup("speechRecognitionNotSupported");
        }
    });

    cameraBtn.addEventListener("click", () => {
        const camInput = document.createElement("input");
        camInput.type = "file";
        camInput.accept = "image/*";
        camInput.capture = "environment";
        camInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) {
                callAI(translations[currentLanguage].analyzeImage || "Analyze this photo", file);
            }
        });
        camInput.click();
    });

    cancelBtn.addEventListener("click", () => {
        if (currentAbortController) {
            currentAbortController.abort();
        }
    });

    locationBtn.addEventListener("click", updateLocationAndWeather);
    aiNavBtn.addEventListener("click", openAI);
    closeAiBtn.addEventListener("click", closeAI);
    settingsBtn.addEventListener("click", openSettings);
    closeSettingsBtn.addEventListener("click", closeSettings);
    languageSelect.addEventListener("change", (e) => {
        updateLanguage(e.target.value);
    });

    newChatBtn.addEventListener("click", () => {
        resetChatHistory();
        showInfoPopup("newChatStarted");
    });

    // --- Carousel Logic ---
    const carousel = document.getElementById("carousel");
    const cards = Array.from(carousel.querySelectorAll(".card"));
    const dotsContainer = document.getElementById("dots");
    let index = 0;

    function createDots() {
        dotsContainer.innerHTML = '';
        cards.forEach((_, i) => {
            const dot = document.createElement("div");
            dot.className = "dot" + (i === 0 ? " active" : "");
            dot.addEventListener("click", () => scrollToIndex(i));
            dotsContainer.appendChild(dot);
        });
    }

    function updateDots() {
        Array.from(dotsContainer.children).forEach((d, i) => d.classList.toggle("active", i === index));
    }

    function scrollToIndex(i) {
        index = i;
        cards[i].scrollIntoView({ behavior: "smooth", inline: "center" });
        updateDots();
    }

    document.querySelector(".arrow.left").addEventListener("click", () => {
        index = Math.max(0, index - 1);
        scrollToIndex(index);
    });

    document.querySelector(".arrow.right").addEventListener("click", () => {
        index = Math.min(cards.length - 1, index + 1);
        scrollToIndex(index);
    });

    carousel.addEventListener("scroll", () => {
        clearTimeout(carousel._t);
        carousel._t = setTimeout(() => {
            const rect = carousel.getBoundingClientRect();
            let bestIndex = 0;
            let bestDiff = Infinity;
            cards.forEach((c, i) => {
                const r = c.getBoundingClientRect();
                const center = (r.left + r.right) / 2;
                const diff = Math.abs(center - (rect.left + rect.right) / 2);
                if (diff < bestDiff) {
                    bestDiff = diff;
                    bestIndex = i;
                }
            });
            index = bestIndex;
            updateDots();
        }, 80);
    });

    // --- NEW: Swipe Gesture Logic ---
    function handleSwipeStart(e) {
        startX = e.changedTouches[0].pageX;
    }

    function handleSwipeEnd(e, panel, closeFunction, swipeDirection) {
        const endX = e.changedTouches[0].pageX;
        const diffX = endX - startX;
        
        if (swipeDirection === 'right' && diffX > swipeThreshold) {
            closeFunction();
        }
        else if (swipeDirection === 'left' && diffX < -swipeThreshold) {
            closeFunction();
        }
    }

    aiPanel.addEventListener('touchstart', handleSwipeStart);
    aiPanel.addEventListener('touchend', (e) => handleSwipeEnd(e, aiPanel, closeAI, 'right'));

    settingsPanel.addEventListener('touchstart', handleSwipeStart);
    settingsPanel.addEventListener('touchend', (e) => handleSwipeEnd(e, settingsPanel, closeSettings, 'left'));

</script>
</body>
</html>
